import{H as U,B as j}from"./Brief-Dsns6DS1.js";import{A as E}from"./ArticleItem-CNpZcfUV.js";import{f as G,g as v,u as q,h as V,d as O,i as J,j as K,c as y,b as z,k as N,l as Q,m as W,n as h,o as k,a as M,_ as R}from"./index-vHkR6Xec.js";import{g as x,a as X,b as Y,c as B,l as P,d as D}from"./articles-cyklCtDv.js";import{g as F,c as Z}from"./comments-BwFQ22WX.js";import"./UserCircleRegular-DcZmVKiu.js";import"./time-Pdvgg59k.js";import"./Media-COzH9Z4j.js";const m=V(),C=q(),H=v({}),p=v({}),I=G("feed",()=>{const l=v([]),r=v(0),s=v(!1),f=v(!0),o=v({}),_=async e=>{try{if(!l.value.find(a=>a.id===e)){const a=C.token?void 0:x(),d=await X(e,a);l.value.push(d.data)}}catch(t){console.error(`获取文章 ${e}失败`,t)}},w=async e=>{try{const t=await Y(e);H.value[e]=t.data}catch(t){console.error(`获取文章 ${e} 的点赞人列表失败:`,t)}},S=async()=>{s.value=!0;try{const e=C.token?void 0:x(),t=await B({page:1,pageSize:5},e);return l.value=t.data.data,r.value=1,f.value=l.value.length<t.data.total,!0}catch(e){return console.error("获取初始文章失败：",e),!1}finally{s.value=!1}},A=async()=>{if(s.value||!f.value)return{status:0};s.value=!0;try{const e=r.value+1,t=C.token?void 0:x(),a=await B({page:e,pageSize:5},t);if(a.data.data.length>0){const d=new Set(l.value.map(u=>u.id)),n=a.data.data.filter(u=>!d.has(u.id));return l.value.push(...n),r.value+=1,f.value=l.value.length<a.data.total,{status:1}}}catch(e){return console.error("获取更多文章失败:",e),{status:2,error:e}}finally{s.value=!1}},b=async e=>{const t=l.value.find(u=>u.id===e);if(!t){console.error(`未在 Store 中找到 ID 为 ${e} 的文章`);return}const a=t.isLiked,d=t.like_count;a?(t.isLiked=!1,t.like_count--):(t.isLiked=!0,t.like_count++);const n=v(1);try{if(C.token)return t.isLiked?(n.value=m.show("正在点赞","loading"),await P(e),m.update(n.value,{text:"点赞成功",type:"success",duration:2e3})):(n.value=m.show("正在取消点赞","loading"),await D(e),m.update(n.value,{text:"取消点赞成功",type:"success",duration:2e3})),await w(e),!0;{const u=x();t.isLiked?(n.value=m.show("正在点赞","loading"),await P(e,u),m.update(n.value,{text:"点赞成功",type:"success",duration:2e3})):(n.value=m.show("正在取消点赞","loading",2e3),await D(e,u),m.update(n.value,{text:"取消点赞成功",type:"success",duration:2e3}))}return!0}catch(u){return console.error(`为文章 ${e} 更新点赞状态失败：`,u),t.isLiked=a,t.like_count=d,u.response.status===429?n.value!==null?(m.update(n.value,{text:"操作过于频繁，请稍后重试",type:"error",duration:2e3}),!1):(console.error("id 变量为 null，无法传递给函数"),m.update(n.value,{text:"操作过于频繁，请稍后重试",type:"error",duration:2e3}),!1):(m.update(n.value,{text:"操作失败，请稍后重试",type:"error",duration:2e3}),!1)}};function L(e,t){const a=p.value[e]?.length||0;o.value[e].hasMore=a<t,o.value[e].remaining=t-a}return{articles:l,isLoading:s,hasMore:f,fetchInitialArticles:S,fetchMoreArticles:A,toggleLike:b,fetchInitialComments:async e=>{const t=o.value[e];if(!(t?.isLoading||t?.page>0)){o.value[e]={page:1,pageSize:3,total:0,hasMore:!0,isLoading:!0,remaining:0};try{const a=await F(Number(e),{page:1,pageSize:o.value[e].pageSize});return p.value[e]=a.data.data,o.value[e].total=a.data.total,L(Number(e),a.data.total),!0}catch(a){return console.error("获取初始评论失败：",a),!1}finally{o.value[e].isLoading=!1}}},fetchMoreComments:async e=>{const t=o.value[e];if(!(!t||t.isLoading||!t.hasMore)){o.value[e].isLoading=!0;try{const a=t.page+1,d=t.pageSize,n=await F(e,{page:a,pageSize:d});p.value[e]||(p.value[e]=[]);const u=new Set(p.value[e]?.map($=>$.id)),T=n.data.data.filter($=>!u.has($.id));return p.value[e].push(...T),o.value[e].page=a,L(e,n.data.total),!0}catch(a){return console.error("获取更多更多评论失败：",a),!1}finally{o.value[e].isLoading=!1}}},commentPagination:o,commentsMap:p,createComment:async e=>{try{const t=await Z(e);if(t.data){const a=t.data;p.value[e.articleId]||(p.value[e.articleId]=[]),p.value[e.articleId].push(a);const d=l.value.find(n=>n.id===Number(e.articleId));d&&d.comment_count++}return!0}catch(t){return console.error("创建评论失败：",t),!1}},fetchArticleLikers:w,articleLikesMap:H,fetchSingleArticle:_}}),ee={class:"article-container"},te=["onClick"],se={key:0,class:"status-indicator"},ae={key:1,class:"status-indicator"},ne=O({__name:"ArticleList",setup(l){const r=V(),s=I(),f=v(null);let o=null;const _=v({}),w=async i=>{for(const g of i)s.articleLikesMap[g.id]||await s.fetchArticleLikers(g.id),s.commentsMap[g.id]||await s.fetchInitialComments(g.id)};J(async()=>{const i=r.show("正在加载文章","loading");await s.fetchInitialArticles()?(await w(s.articles),r.update(i,{type:"success",text:"文章加载成功",duration:2e3})):r.update(i,{type:"error",text:"文章加载失败",duration:2e3}),o=new IntersectionObserver(async c=>{if(c[0].isIntersecting){console.log("滚动到底部，加载更多...");const e=r.show("正在加载文章","loading"),t=s.articles.length,a=await s.fetchMoreArticles();if(a?.status===0)r.update(e,{type:"info",text:"没有更多文章了",duration:2e3});else if(a?.status===1){const d=s.articles.slice(t);await w(d),r.update(e,{type:"success",text:"文章加载成功",duration:2e3})}else r.update(e,{type:"error",text:"文章加载失败",duration:2e3})}},{rootMargin:"0px 0px 10px 0px"}),f.value&&o.observe(f.value)}),K(()=>{o&&f.value&&o.unobserve(f.value)});function S(i){s.toggleLike(i)}function A(i){_.value[i]=!_.value[i]}async function b(i){const g=r.show("正在创建评论","loading");await s.createComment(i)?r.update(g,{type:"success",text:"评论成功",duration:2e3}):r.update(g,{type:"error",text:"评论失败",duration:2e3})}function L(i){s.fetchMoreComments(i)}return(i,g)=>(k(),y("div",ee,[z("ul",null,[(k(!0),y(Q,null,W(h(s).articles,c=>(k(),y("li",{key:c.id,onClick:e=>console.log(c)},[M(E,{article:c,likers:h(s).articleLikesMap[c.id]||[],comments:h(s).commentsMap[c.id]||[],"is-show-input":!!_.value[c.id],"has-more-comments":h(s).commentPagination[c.id]?.hasMore??!1,"remaining-comments":h(s).commentPagination[c.id]?.remaining??0,"is-loading-comments":h(s).commentPagination[c.id]?.isLoading??!1,onLike:S,onComment:()=>A(c.id),onSendReply:b,onLoadMoreComments:()=>L(c.id)},null,8,["article","likers","comments","is-show-input","has-more-comments","remaining-comments","is-loading-comments","onComment","onLoadMoreComments"])],8,te))),128))]),z("div",{ref_key:"scrollTrigger",ref:f,class:"scroll-trigger"},null,512),h(s).isLoading?(k(),y("div",se," 正在加载中... ")):N("",!0),!h(s).hasMore&&h(s).articles.length>0?(k(),y("div",ae," - 没有更多了 - ")):N("",!0)]))}}),oe=R(ne,[["__scopeId","data-v-124a8766"]]),re={class:"container"},ie=O({__name:"Index",setup(l){return(r,s)=>(k(),y("div",re,[M(U),M(j),M(oe)]))}}),ve=R(ie,[["__scopeId","data-v-e4580539"]]);export{ve as default};
